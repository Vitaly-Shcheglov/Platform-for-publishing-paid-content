# Проект "Платформа для публикации платного контента"/ "Platform for publishing paid content"

## Описание

Этот проект представляет собой веб-платформу на Django, которая позволяет пользователям публиковать как бесплатные, так и платные записи. Бесплатные записи доступны всем без регистрации, платные — только авторизованным пользователям, которые оплатили разовую подписку. Регистрация пользователей осуществляется по номеру телефона. Оплата подписки производится через Stripe. Фронтенд реализован на основе готовых Bootstrap-шаблонов, чтобы обеспечить приятный и адаптивный интерфейс. Приложение упаковано в Docker/ Docker Compose и хранит данные в PostgreSQL. API защищены JWT, а все сервисы документированы и тестированы.

## Содержание

- [Что реализует проект](#тчто-реализует-проект)
- [Целевая архитектура и стек](#целевая-архитектура-и-стек)
- [Требования к реализации и соответствие тегам](#требования-к-реализации-и-соответствие-тегам)
- [Примеры ключевых компонентов (идеи)](#примеры-ключевых-компонентов-(идеи))
- [Поддержка и расширение](#поддержка-и-расширение)
- [Функциональность](#функциональность)
- [Настройка для запуска в локальном окружении (без Docker)](#настройка-для-запуска-в-локальном-окружении-(без Docker))
- [Настройка проекта для запуска в Docker Compose](#настройка проекта для запуска в Docker Compose)
- [Команды для разработки](#команды-для-разработки)
- [Регистрация по номеру телефона](#регистрация-по-номеру-телефона)
- [Публикация записей](#публикация-записей)
- [Оплата подписки Stripe](#оплата-подписки-Stripe)
- [Безопасность и аутентификация](#безопасность-и-аутентификация)
- [Фронтенд и UX](#фронтенд-и-UX)
- [Документация и развёртывание](#документация-и-развёртывание)
- [Требования к тестированию](#требования-к-тестированию)
- [Задачи по блогу](#задачи-по-блогу)
- [Управление рассылками сообщений для клиентов](#управление-рассылками-сообщений-для-клиентов)
- [Структура проекта](#структура-проекта)
- [Контакты](#контакты)

## Что реализует проект

1. Публикация записей:
  - Бесплатные записи доступны всем пользователям без регистрации.
  - Платные записи доступны только авторизованным пользователям, прошедшим оплату подписки.
2. Регистрация и аутентификация:
  - Регистрация по номеру телефона.
  - Использование JWT для защиты API и управления сессиями пользователей.
3. Оплата и подписка:
  - Интеграция Stripe для обработки разовой оплаты подписки на доступ к платному контенту.
  - Управление статусами доступа в зависимости от успешной оплаты.
4. Фронтенд:
  - Интерфейс на основе Bootstrap-шаблонов.
  - Страницы отображения записей, карточки пользователей, формы создания и редактирования записей, страницы платной регистрации и оплаты.
5. Архитектура и инфраструктура:
  - Фреймворк: Django.
  - База данных: PostgreSQL.
  - ORM: встроенная Django ORM.
  - Контейнеризация: Docker и Docker Compose.
6. Документация: README.md с описанием структуры проекта и инструкциями по установке и запуску.
7. Качество и тестирование:
  - Код следует стандартам PEP8.
  - Тесты покрывают как минимум 75% функционала.
8. Весь код хранится в удаленном Git-репозитории и доступен для команды разработки.

## Инструметы и технологии

### Целевая архитектура и стек

  - Django: версия 4.x или актуальная на момент проекта. Использовать новейшие стабильные возможности фреймворка, включая классическую ORM, Django Templates и встроенные механизмы админки.
  - PostgreSQL: основная СУБД для хранения структурированных данных, индексов и функций.
  - Django ORM: для моделирования данных, фильтрации и взаимодействия с БД без прямых SQL-запросов.
  - JWT: аутентификация и авторизация API. Реализация через библиотеку djangorestframework-simplejwt или аналогичную, с настройкой access и refresh токенов.
  - Stripe API: обработка онлайн-платежей, подписок и платежей. Использовать Stripe Python SDK и вебхуки для событий о платежах.
  - Bootstrap: фронтенд-стилизация. Подключение через CDN или локальные статические файлы, совместная с Django Templates.
  - Django Templates: рендеринг HTML на стороне сервера, формы и валидация через Django форм.
  - Docker и Docker Compose: контейнеризация проекта для локального запуска, сборка образов и зависимостей, настройка сети между сервисами (web, db, redis, платежные вебхуки при необходимости).
  - Git: контроль версий. Один удалённый репозиторий для командной работы, ветвление по GitFlow или другой подход, CI/CD по желанию.
  - Линтеры и тесты PEP8: настройка flake8/ruff для линтинга кода, pytest для тестов, соблюдение PEP8 и стилей кода.

### Требования к реализации и соответствие тегам

  - Django: реализация проекта с использованием стандартных проектов и приложений Django, модульной структурой, на основе Django 4.x. Включение settings для разных сред (local, dev, prod), управление секретами через переменные окружения.
  - Git: хранение исходного кода в одном удалённом репозитории. Чёткая структура веток, руководство по мердж-реквестам и код-ревью.
  - JWT: защита API. Реализация авторизации через JWT на уровне DRF или собственного слоя. Правила истечения токенов, безопасное хранение секретного ключа, обновление токенов через рефреш.
  - ORM: использование Django ORM для всех операций с данными. Исключение прямых SQL-запросов, за исключением редкостных случаев через Raw SQL с осторожной проверкой.
  - PEP8: кодовую базу выровнять под PEP8. Инструменты: flake8/ruff, Black для форматирования, pre-commit хуки.
  - PostgreSQL: проект настроен на работу с PostgreSQL. Включён пример миграций, индексов, ограничений, транзакций.
  - Readme: в корне проекта есть подробный README с описанием установки, настройки окружения, запуска локально и в Docker, конфигурации Stripe и JWT, тестами и пр.
  - Auth: реализована полноценная аутентификация и авторизация пользователей через JWT, модели пользователей и группы/ролей по необходимости.
  - Docker: проект полностью готов к запуску в Docker. Dockerfile для веб-приложения, Dockerfile/образ для дополнительных сервисов (например, Redis, если нужен для очередей или сессий). Примеры команд сборки и запуска в документации.
  - Docker-Compose: оркестрация сервисов через docker-compose. Включены сервисы web, db (PostgreSQL), possibly redis, объяснение переменным окружения, миграций и загрузки статических файлов.
  - Сторонние API: интеграция с внешними API (Stripe для платежей, возможно вебхуки). Примеры адаптеров/клиентов для взаимодействия с удалёнными сервисами.
  - Forms: Django формы используются для создания и редактирования данных в интерфейсе. Валидаторы на уровне форм и моделей, обработка ошибок в UI.
  - Templates: полная поддержка Django Templates. Шаблоны для страниц регистрации/логина, профиля, платежей, админ-панели, документации по API.
  - Templates и Forms совместимы: аккуратно построены базовые шаблоны и переиспользуемые части (extends, блоки, включения).
  - Readme: в Readme добавлены инструкции по локальной настройке, развёртыванию в Docker, настройке Stripe, настройке JWT, инструкции по миграциям и тестам.

## Примеры ключевых компонентов (идеи)

1. Модель Post:
  - title: CharField
  - content: TextField
  - author: ForeignKey(User)
  - is_paid: BooleanField
  - price: DecimalField (nullable)
  - created_at: DateTimeField(auto_now_add=True)
  - published_at: DateTimeField(null=True)
2. Модель Subscription:
  - user: ForeignKey(User)
  - stripe_customer_id: CharField
  - status: CharField (choices: active, past_due, canceled)
  - created_at: DateTimeField(auto_now_add=True)
3. Регистрация по телефону:
  - PhoneNumberField (или CharField с валидацией)
  - OTP-сервис (модуль с реализацией или интеграция со сторонним провайдером)
  - JWT-токен после успешной регистрации

## Поддержка и расширение

1. Возможна замена OTP-сервиса на конкретного провайдера (Twilio, Infobip и т.д.) с минимальными изменениями в коде.
2. Stripe можно переключить на другой платежный шлюз при необходимости, сохранив общую логику подписок и доступа.

## Функциональность

- Главная страница: Отображает приветственное сообщение и основную информацию о магазине.
- Контактная информация: Страница с формой обратной связи, где пользователи могут отправлять свои сообщения.
- Django ORM: Подключение PostgreSQL к проекту, создание и настройка моделей Product и Category, перенос их в базу данных с помощью миграций, регистрация и настройка модели в админке, наполнение базы данных через Django shell, создание фикстуры для моделей и реализация кастомных команд для добавления тестовых данных.
- Шаблонизация: На главной странице отображается список товаров, и каждое описание товара ограничено первыми 100 символами, пользователи могут просмотреть всю информацию о конкретном товаре, перейдя на соответствующую страницу, для упрощения управления кодом был выделен базовый шаблон, который включает общие элементы страницы, такие как шапка, подвал и стили, создан подшаблон для отображения главного меню, который можно использовать в других шаблонах.
- Блог: Раздел блога, где пользователи могут просматривать статьи, создавать новые записи и редактировать существующие.
- Механизм CRUD: Реализованы формы для  создания новых продуктов, просмотра списка продуктов, обновления информации о продукте, удаления продукта из базы данных.
- Аутентификация: Работа с пользователями, аутентификация пользователей, ограничение доступа.
- Настройка прав пользователей для управления продуктами и постами блога: Реализована функциональность для управления статусом публикации продуктов и добавления пользователей в группы с соответствующими разрешениями.
- Задачи по кэшированию:Установлен брокер для кэширования,настроено кеширование для страницы, которая отображает информацию об одном продукте, добавлено низкоуровневое кеширование для списка продуктов.
- Вынесение бизнес-логики в сервисный слой: Создана сервисную функцию для работы с продуктами.
- Управление рассылками сообщений для клиентов: Включает функциональность для создания, просмотра, редактирования и удаления рассылок, а также отправки сообщений по требованию.

## Настройка для запуска в локальном окружении (без Docker)

Для установки и настройки проекта выполните следующие шаги:
1. Клонируйте репозиторий:
      git clone https://github.com/Vitaly-Shcheglov/Platform-for-publishing-paid-content.git
2. Создайте и активируйте виртуальное окружение:
   Для Windows:
      python -m venv .venv
   .\venv\Scripts\Activate
   Для macOS и Linux:
      python3 -m venv .venv
   source .venv/bin/activate
3. Установите зависимости:
   Убедитесь, что у вас есть файл requirements.txt в корне проекта. Если его нет, создайте его и добавьте туда необходимые зависимости:
      pip install django
   Затем установите все зависимости:
      pip install -r requirements.txt
4. Примените миграции:
      python manage.py migrate
5. Запустите сервер:
      python manage.py runserver 8000
   Теперь вы можете открыть браузер и перейти на главную страницу по адресу [http://localhost:8000](http://localhost:8000).
   Переход по разделам бесплатных публикаций доступен незарегистрированным пользователям о ссылкам в хэдере на главной странице странице публикаций.
   Переход по разделам платных публикаций, блоговых сообщений, рассылок, пользователей, статистики рассылок доступен для зарегистрированных пользователей по ссылкам в хэдере на главной странице.


## Настройка проекта для запуска в Docker Compose

1.  Общая структура проекта:
docker-compose.yml — конфигурация для запуска сервисов (база данных, веб-сервер, фоновые задачи и пр.).
Dockerfile для основного сервиса (backend).
app/ — исходники приложения (модели, маршруты, сервисы).
tests/ — тесты.
config/ — конфигурационные файлы и переменные окружения.
README.md — документация по запуску и настройке.
.env.example — шаблон переменных окружения.

2. Предварительные требования
Docker и Docker Compose установленны на вашей машине.
Git установлен.
доступ к интернету для загрузки образов и зависимостей.

3. Клонирование проекта
git clone https://github.com/Vitaly-Shcheglov/Platform-for-publishing-paid-content.git
cd repository

4. Конфигурация окружения
Скопируйте пример окружения:
cp .env.example .env
Отредактируйте .env, указав:
DATABASE_URL или параметры БД (Host, Port, DB name, user, password)
JWT_SECRET или аналогичный секрет
REDIS_URL (если используются кэш/очереди)
STRIPE_API_KEY и/или другие ключи оплаты
APP_HOST, APP_PORT
DEBUG или ENVIRONMENT (production/development)
Любые другие сервисы (email, внешние API)

5. Настройка и сборка Docker-контейнера
Собираем образы и запускаем сервисы:
docker-compose up -d --build
При первом запуске образы будут загружены/собраны, создаются сети и тома.

6. Митье базы данных и миграции
Если проект использует миграции:
docker-compose exec web python manage.py migrate
Если используется другой стек, запустите соответствующую команду миграций из контейнера веб-приложения.

7. Создание суперпользователя (при необходимости)
docker-compose exec web python manage.py createsuperuser
или аналогичная команда, зависящая от фреймворка.

8. Запуск сервиса
Локально на 80/8000 порт:
docker-compose up -d
Проверьте логи на предмет ошибок:
docker-compose logs -f

9. Проверка работоспособности
Откройте в браузере http://localhost:8000 (или указанный APP_HOST:APP_PORT).
Выполните базовые запросы к API:

10. Регистрация пользователя
Логин и получение JWT
Создание подписки (если есть схема оплаты)
Вебхуки Stripe (при необходимости)

11. Тестирование
Установите зависимости и запустите тесты:
docker-compose run --rm web pytest --maxfail=1 --disable-warnings -q
Если есть CI, настройте шаги:
Установка зависимостей
Запуск миграций
Запуск тестов
Анализ покрытия тестами

12. Безопасность и настройки продакшн
Переменные окружения в продакшн не хранить в репозитории; используйте безопасное хранилище секретов.
Включить HTTPS в обратном прокси (Nginx/Traefik) и настроить редиректы с HTTP на HTTPS.
Ограничить доступ к админ-панели, включить CSRF-защиту и secure cookies.
Настроить регулярное обновление зависимостей и мониторинг.

13. Расширенная настройка
Подключение к внешним сервисам (Stripe, SendGrid, S3) — проверьте переменные в .env и соответствующие конфигурационные файлы.
Включение кэширования (Redis) и очередей задач (RabbitMQ, BullMQ и т.д.) при необходимости.
Включение логирования в центральную систему (ELK/ Loki) по требованию.

14. Чек-лист после установки
Убедиться, что все сервисы работают (порты, статусы, логи не содержат ошибок).
Проверить конфигурацию окружения и secrets.
Пройти базовые сценарии использования API.
Проверить миграции в рабочем окружении.

## Команды для разработки

### Общий набор команд и инструкций для разработки и эксплуатации платформы на стеке Django + Django REST Framework + Docker:

1. Подготовка окружения
Установить зависимости локально:
- python -m venv venv
- source venv/bin/activate (windows: venv\Scripts\activate)
- pip install -r requirements.txt

2. Установка переменных окружения (пример .env):
DJANGO_SECRET_KEY=your_secret_key
DEBUG=True
DATABASE_URL=postgres://user:password@db:5432/dbname
Убедиться, что база данных доступна и миграции проходят:
- python manage.py makemigrations
- python manage.py migrate

3. Запуск в локальном окружении (без Docker)
Запуск локального сервера разработки:
- python manage.py runserver 8000
Создание суперпользователя для доступа в админку:
- python manage.py createsuperuser
Сбор статических файлов:
- python manage.py collectstatic —noinput
Запуск кастомных команд:
- python manage.py create_groups - для создания определённых групп пользователей
- python manage.py create_superuser - для создания суперпользователя
- python manage.py load_categories - для загрузки категорий и субкатегорий в базу данных
- python manage.py loaddata subscriptions.json - для загрузки начальных данных в базу данных  с данными о подписках пользователя с идентификатором 1
- python manage.py loaddata users.json - для создания двух пользователей в модели users.customuser с заданными полями и первичными ключами

4. Работа с API (DRF)
Просмотр доступных маршрутов:
- python manage.py show_urls (если установлен django-extensions или аналог)
Тестирование API через curl:
- curl -i http://127.0.0.1:8000/api/auth/token/ (для получение токена).
- curl -H "Authorization: Bearer <token>" http://127.0.0.1:8000/api/ваш-эндпойнт/
Тестирование с Postman/Insomnia: импортируйте OpenAPI/Swagger, если включено.

5. Docker-ориентированная разработка
Сборка образа:
- docker-compose build
Запуск контейнеров:
- docker-compose up -d
Миграции в контейнере Django:
- docker-compose exec web python manage.py migrate
Создание суперпользователя в контейнере:
- docker-compose exec web python manage.py createsuperuser
Сборка статических файлов в контейнере:
- docker-compose exec web python manage.py collectstatic --noinput
Остановка и удаление контейнеров:
- docker-compose down

6. Архитектура и конфигурация Docker (пример)
Файлы:
docker-compose.yml:
сервисы: django (web), db (PostgreSQL), nginx (reverse proxy), celery (если есть задача фонова).
Dockerfile для Django:
-FROM python:3.x
-WORKDIR /app
-COPY requirements.txt .
-RUN pip install -r requirements.txt
-COPY . .
-CMD ["gunicorn", "project.wsgi:application", "--bind", "0.0.0.0:8000"]
Миграции и статику чаще выполняют в процессе сборки/рантайма внутри контейнера.

7. Обеспечение безопасности и конфигураций
Использовать переменные окружения для секретов и настроек.
В продакшн включить DEBUG=False, ALLOWED_HOSTS настроить.
Настроить CSRF, CORS по мере необходимости.
Настроить бэкенд-логирование и ротацию логов.

8. Мониторинг и resilience
Настроить health check для сервиса Django:
В docker-compose добавьте healthcheck:
test: ["CMD", "curl", "-f", "http://localhost:8000/health/"]
interval: 30s
timeout: 10s
retries: 3
Включить логирование и сбор метрик (Prometheus + Grafana при необходимости).

9. Миграции и фиксы в проде
Применение миграций без простоя:
- docker-compose exec web python manage.py migrate --noinput
Применение фиксов и миграций во время CI/CD:
В пайплайне запускать миграции после деплоя.

10. Бэкап и восстановление БД
Резервное копирование PostgreSQL (локально):
docker exec -t db_pg_container pg_dump -c -U postgres yourdb > backup.sql
Восстановление:
- psql -U postgres -d yourdb -f backup.sql
Типовые команды для удобства
Проверка версии Python и установленных пакетов:
- python --version
- pip list
Проверка миграций:
- python manage.py showmigrations
Очистка старых миграций/кешей:
- find . -path "/migrations/.py" -name "init.py" -prune -o -print (аккуратно, избегайте удаления активных файлов)


## Реализованные задачи:

## Регистрация по номеру телефона

1. Поток регистрации: пользователь вводит номер телефона → отправляется код подтверждения (OTP) → пользователь вводит код → создается пользовательский аккаунт и выдается JWT-токен.
2. Хранение данных: телефон как уникальный идентификатор пользователя, минимально необходимые поля (номер телефона, имя по желанию, дата создания).

## Публикация записей

1. Модель Post имеет поля: title, content, created_at, author (FK на User), is_paid (Boolean), price (Decimal, если is_paid), published_at, status.
2. Бесплатные записи: режим доступа open; доступны всем.
3. Платные записи: доступ по действующей подписке (проверка JWT и состояния подписки).

## Оплата подписки Stripe

1. Интеграция Stripe Checkout или Payment Intents для разовой покупки подписки.
2. Логика: пользователь оплачивает подписку → создается Subscription объект → выдается JWT с правами доступа к платному контенту.
3. Webhook Stripe для обновления статуса подписки и учетной записи пользователя.
4. В коде предусмотрены тестовые ключи Stripe в тестовом окружении.

## Безопасность и аутентификация

1. JWT (JSON Web Tokens) для защиты API и управления сессиями.
2. Защита критических маршрутов: только авторизованные пользователи могут видеть платный контент.
3. Безопасная передача данных через HTTPS (при деплое, настройка через Nginx/HTTPS в Docker).

## Фронтенд и UX

1. Шаблоны Bootstrap с адаптивной версткой.
2. Страницы: главная лента записей, страница записи с доступом к содержимому, страница регистрации/входа, страница оплаты, страница профиля пользователя.
3. Удобная навигация, фильтры по бесплатным/платным записям.

## Документация и развёртывание

1. README.md содержит:
2. Обзор проекта и функциональность.
3. Инструкции по установке и запуску локально (Docker Compose).
4. Конфигурационные переменные (ENV) для Django, PostgreSQL, Stripe.
5. Команды для сборки и запуска, миграций, запуска тестов.
6. Руководство по тестированию и покрытию кода.
7. Руководство по развёртыванию в продакшн окружении (опционально).
8. Все изменения и код размещаются в удаленном Git репозитории; ветвление по функциональности (features, hotfixes).
9. Код соответствует PEP8; линтер и тесты в CI.

## Требования к тестированию

1. Покрытие тестами не менее 75% по ключевым модулям:
2. Модели: валидации и связи.
3. Аутентификация: регистрация по номеру телефона, JWT выдача и валидация.
4. Права доступа: доступ к бесплатному и платному контенту в зависимости от подписки.
5. Оплата: интеграция Stripe (моки/стаб-токены) и обработка вебхуков.
6. Фронтенд: базовые тесты рендеринга страниц и форм (если тестирование фронтенда реализовано на уровне шаблонов или через инструментальные тесты).

## Задачи по блогу

1. Перевод контроллеров с FBV на CBV: Все контроллеры приложения catalog переведены в CBV.
2. Создание нового приложения для блога и добавление его в файл settings.py.
3. Создание модели блоговой записи со следующими полями:
   - заголовок,
   - содержимое,
   - превью (изображение),
   - дата создания,
   - признак публикации (булевое поле),
   - количество просмотров.
4. Реализация полного CRUD для новой модели, используя CBV.
5. Увеличение счетчика просмотров: при открытии отдельной статьи увеличивать счетчик просмотров.
6. Фильтрация опубликованных статей: выводить в список статей только те, которые имеют положительный признак публикации.
7. Перенаправление после редактирования: после успешного редактирования записи перенаправлять пользователя на просмотр этой статьи.
8. Дополнительное задание: Когда статья достигает 100 просмотров, отправляйте себе на почту поздравление с достижением.

## Управление рассылками сообщений для клиентов

1. Управление клиентами: Добавление, просмотр, редактирование и удаление получателей рассылки.
2. Управление сообщениями: Добавление, просмотр, редактирование и удаление сообщений.
3. Управление рассылками: Добавление, просмотр, редактирование и удаление рассылок.
4. Статусы рассылки: Поддержка статусов (Создана, Запущена, Завершена) для отслеживания состояния рассылок.
5. Отправка сообщений: Возможность отправки сообщений вручную через интерфейс пользователя и командную строку.
6. Попытки рассылок: Хранение информации о каждой попытке отправки сообщения, включая дату, время, статус и ответ почтового сервера.
7. Статистика и отчеты: Сбор и отображение информации о количестве успешных и неуспешных попыток рассылок.
8. Регистрация и аутентификация пользователей: Реализация системы регистрации, входа и выхода из системы, восстановление пароля.
9. Статистика и отчеты: Сбор информации о количестве успешных и неуспешных попыток рассылок и количестве отправленных сообщений.

## Контакты

Если у вас есть вопросы или предложения по улучшению проекта, пожалуйста, свяжитесь с автором:

- Имя: Виталий Щеглов
- Email: cgfhnfr4@gmail.com
- GitHub: (https://github.com/Vitaly-Shcheglov)

---