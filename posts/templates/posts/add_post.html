{% extends 'posts/base.html' %}

   {% block content %}
   <div class="container">
       <h1>Добавить публикацию</h1>
       <form method="POST" enctype="multipart/form-data">
           {% csrf_token %}

           <div class="mb-3">
               <label for="{{ form.title.id_for_label }}" class="form-label">{{ form.title.label }}</label>
               {{ form.title }}
               {% if form.title.errors %}
                   <div class="text-danger">
                       {% for error in form.title.errors %}
                           <p>{{ error }}</p>
                       {% endfor %}
                   </div>
               {% endif %}
           </div>

           <div class="mb-3">
               <label for="{{ form.content.id_for_label }}" class="form-label">{{ form.content.label }}</label>
               {{ form.content }}
               {% if form.content.errors %}
                   <div class="text-danger">
                       {% for error in form.content.errors %}
                           <p>{{ error }}</p>
                       {% endfor %}
                   </div>
               {% endif %}
           </div>

           <div class="mb-3">
            <label for="{{ form.image.id_for_label }}" class="form-label">{{ form.image.label }}</label>
            {{ form.image }}
            {% if form.image.errors %}
                <div class="text-danger">
                    {% for error in form.image.errors %}
                        <p>{{ error }}</p>
                    {% endfor %}
                </div>
            {% endif %}
           </div>

           <div class="mb-3">
               <label for="{{ form.category.id_for_label }}" class="form-label">{{ form.category.label }}</label>
               {{ form.category }}
               {% if form.category.errors %}
                   <div class="text-danger">
                       {% for error in form.category.errors %}
                           <p>{{ error }}</p>
                       {% endfor %}
                   </div>
               {% endif %}
           </div>

           <div class="mb-3">
               <label for="{{ form.subcategory.id_for_label }}" class="form-label">{{ form.subcategory.label }}</label>
               <select name="subcategory" id="id_subcategory" class="form-control">
                   <option value="">Выберите подкатегорию</option>
                   {% for subcategory in form.subcategory %}
                       <option value="{{ subcategory.value }}">{{ subcategory.label }}</option>
                   {% endfor %}
               </select>
               {% if form.subcategory.errors %}
                   <div class="text-danger">
                       {% for error in form.subcategory.errors %}
                           <p>{{ error }}</p>
                       {% endfor %}
                   </div>
               {% endif %}
           </div>

           <button type="submit" class="btn btn-primary">Создать запись</button>
           <a href="{% url 'post_list' %}" class="btn btn-secondary">Назад к списку публикаций</a>
       </form>
   </div>

   <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
   <script>
       $(document).ready(function() {
           $('#id_category').change(function() {
               var categoryId = $(this).val();
               $.ajax({
                   url: '{% url "get_subcategories" %}',
                   data: {
                       'category': categoryId
                   },
                   success: function(data) {
                       $('#id_subcategory').empty();
                       $('#id_subcategory').append('<option value="">Выберите подкатегорию</option>');
                       $.each(data, function(index, item) {
                           $('#id_subcategory').append($('<option></option>').attr('value', item.id).text(item.name));
                       });
                   },
                   error: function(xhr, status, error) {
                       console.error('Ошибка при получении подкатегорий:', error);
                   }
               });
           });
       });
   </script>
   {% endblock %}
